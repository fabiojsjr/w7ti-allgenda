<%@page import="java.text.DateFormat"%>
<%@page import="com.tetrasoft.data.cliente.Calendario"%>
<%@page import="com.tetrasoft.data.cliente.TaskEntity"%>
<%@page import="java.util.Date"%>
<%@ page language="java" contentType="text/html; charset=ISO-8859-1" pageEncoding="ISO-8859-1"%>
<%@page import="java.text.SimpleDateFormat"%>
<%@page import="java.util.ArrayList"%>
<%@page import="java.sql.Connection"%>

<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="js/fullcalendar.min.js"></script>


<a id="dynCalendar" style="overflow: auto;" class="grouped_elements"></a>			



<script type="text/javascript" id="runscript">
	<!-- CALENDÁRIO -->
	var start = 0;
	var date = new Date();
	var d = date.getDate();
	var m = date.getMonth();
	var y = date.getFullYear();

	var eventoSelecionado;
	var acesso = false;
	
	function vinculaEventoClick(){
		
	$(document).on('click','.fc-agenda-slots tbody tr',function(e){				
			
			let linhaHora = document.getElementById('dynCalendar');
			linhaHora.href= "calendarioEdit.jsp?start=" + start + "&idCalendario=<%= idCalendario %>";
			
			let hora = $(this).find("th").text();
			if(hora.trim() == "")				
				hora = $(this).prev().find("th").text();				
			linhaHora.click();	
			
			setTimeout(function(){				
				if($("#emailSolicitante").val().trim().length < 1){										
					$("[name='horaTask']").val(hora.substring(0,hora.indexOf(':')) + ' : ' + hora.substring(hora.indexOf(':') + 1,hora.length));
					$("[name='dataTask']").val("");
				}
			},400);
				
		});		
	}

	jQuery(document).ready(function() {		
		
		setupCalendar();	
		
		vinculaEventoClick();
	
	});

	
	function setupCalendar() {
		var calendar = jQuery('#calendar').fullCalendar({
			header: {
				left: 'prev,next today',
				center: 'title',
				right: 'month,agendaWeek,agendaDay'
			},
			
			<% if( idioma.equals("PT") ) { %>
					monthNames: ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'],
					monthNamesShort: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'], dayNames: ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'], 
					dayNamesShort: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'], buttonText: {   prev: '&nbsp;&#9668;&nbsp;',    next: '&nbsp;&#9658;&nbsp;',  
					prevYear: '&nbsp;&lt;&lt;&nbsp;',   nextYear: '&nbsp;&gt;&gt;&nbsp;',   today: 'hoje',  month: 'mês',   week: 'semana', day: 'dia'  }, 
					titleFormat: {  month: 'MMMM yyyy', week: "d [ yyyy]{ '&#8212;'[ MMM] d MMM yyyy}", day: 'dddd, d MMM, yyyy'    }, 
					columnFormat: { month: 'ddd',   week: 'ddd d/M',    day: 'dddd d/M' },  
					allDayText: 'dia todo', axisFormat: 'H:mm', timeFormat: {   '': 'H(:mm)',   agenda: 'H:mm{ - H:mm}' },
					buttonText: {
						prev: '&laquo;',
						next: '&raquo;',
						prevYear: '&nbsp;&lt;&lt;&nbsp;',
						nextYear: '&nbsp;&gt;&gt;&nbsp;',
						today: 'hoje',
						month: 'mês',
						week: 'semana',
						day: 'dia',
					},
			<%	} %>
			
			eventClick: function(event, element) {				
				eventoSelecionado = event;
				acesso = true;
        		$('#calendar').fullCalendar('updateEvent', event);
    		},
    		//evento de arrastar
			eventDrop: function(event, element) {
				
				var query = "calendarioPainel.jsp?change=true&id=" + event.name;				
				var data = new Date(event.start);				
				var dia = data.getDate();
				var ano = data.getFullYear()
				var mes = Number(data.getMonth());			
				
				if(dia.toString().length == 1)
					dia = "0" + dia;
				
				if(mes.toString().length == 1)
					mes = "0" + mes;
				
				query += "&data=" + ano + '-' + mes + '-' + dia;
				query = query.replace("|task","");					
				
				ChamaPaginaArray(query, "centroPainel", "activateCalendar(1)");
				
    		},
    		
			eventAfterAllRender : function(view){				
				
				$("a[href^='calendarioEdit.jsp']").fancybox(
						{
							titleShow: false,
							transitionIn : 'elastic',
							transitionOut : 'elastic',
							autoDimensions: true,
							overlayShow : true,
							autoScale: true,
							easingIn : 'easeOutBack',
							easingOut : 'easeInBack',
							width: 910,
							scrolling: 'no',
						});
				
				$('a.grouped_elements').fancybox(
					{
						titleShow: false,
						transitionIn : 'elastic',
						transitionOut : 'elastic',
						autoDimensions: true,
						overlayShow : true,
						autoScale: true,
						easingIn : 'easeOutBack',
						easingOut : 'easeInBack',
						width: 910,
						scrolling: 'no',
					});
			},			
			defaultView: 'agendaWeek',
			weekends: false,
			minTime: 7,
			maxTime: 21,
			timeZone: 'America/Sao_Paulo',
			selectable: true,
			selectHelper: true,
			editable: true,
			//height: 1500,
			select: function(start, end, allDay) {	
				
				
				let inicioDia = start.toString().replace(/\s/g,"");
				let numerosDaData = inicioDia.replace(/[^0-9]/g,"");
				let dia = numerosDaData.substring(0,2);	
				
			    document.getElementById('dynCalendar').href= "calendarioEdit.jsp?start=" + start + "&idCalendario=<%= idCalendario %>";
			    document.getElementById('dynCalendar').click();		    
				calendar.fullCalendar('unselect');	
				
				setTimeout(function(){
					if($("#emailSolicitante").val().trim().length < 1){
						let dataForm = $("[name='dataTask']").val();
						let dataFormSplit = dataForm.split("/");
						$("[name='dataTask']").val(dia + "/" + dataFormSplit[1] + "/" + dataFormSplit[2]);					
					}	
				},400);		
				
			},			
			events: [
				<%
					Calendario cal = new Calendario();				
					ArrayList<String> list2 = cal.getTODO( usuarioLogado.getIdUsuario(), idCalendario, false );

					for( String s : list2 ) {
						StringTokenizer st = new StringTokenizer( s, "|");					
						String data       = st.nextToken();
						String id         = st.nextToken();
						String tipoAlerta = st.nextToken();
						if( tipoAlerta.equals("2") ) continue;
						String tipo       = st.nextToken();
						String evento     = st.nextToken();						
						String resp       = st.nextToken();						
						String color      = "red";
						TaskEntity taskAtual = new TaskEntity();
						taskAtual.getThis(" idTask = " + id);
						String dataFinal = "";
						
						if(taskAtual.getIdTask() != null && taskAtual.getIdTask() != 0){
							dataFinal = new SimpleDateFormat("YYYY-MM-dd HH:mm:ss").format(taskAtual.getDataHoraPrazoFinal());
						}
						
						
						if( !usuarioLogado.getIdUsuario().toString().equals( resp ) ) {
							if( TaskEntity.DATE_FORMAT7.parse( data ).before( new Date() ) ) {
								color = "#FF5555";
							} else {
								color = "darkorange";
							}
						} else {
							if( TaskEntity.DATE_FORMAT7.parse( data ).before( new Date() ) ) {
								color = "red";
							}
						}
						
				%>
						{
							name : '<%= id %>|<%= tipo %>',
							title : '<%= evento %>',
							start : new Date('<%= data %>'),
							end: new Date('<%= dataFinal %>'),
							allDay : false,
							color : '<%= color %>',
							url : 'calendarioEdit.jsp?id=<%= id %>&tipo=<%= tipo %>&idCalendario=<%= idCalendario %>'
						},
						
				<%	}	%>	
				
			]
		});
		
	}	
</script>

<%	if( request.getParameter("ajax") == null ) { %>		
			<div id='calendar' style="overflow: auto;"></div>		
<%	} else { %>
		<ul class="breadcrumbs">
			<li><a style="color : black;" href="painel.jsp"><i class="iconfa-user"></i></a> <span class="separator"></span></li>
			<li><%= p.get("ADMINISTRACAO") %><span class="separator"></span></li>
			<li><b>Calendário</b></li>
		</ul>
		
		<div class="pageheader" onclick="javascript:calendario(1,0);" style="cursor: pointer;">
			<div class="pageicon"><span class="iconfa-calendar"></span></div>
			<div class="pagetitle">
				<h5> &nbsp;</h5>
				<h1>Calendário</h1>
			</div>
		</div>

		
		<div id="dashboard-left" class="span8" style="width: 95%; margin-top: 20px">
			<!div class="alert alert-error">
	
			<div class="widgetcontent font1" style="text-align: justify; border-top: 2px solid #2C3E50">				
					<div id='calendar' style="overflow: auto;"></div>				
			</div>
		</div><!--span6-->
		
		  	
<%	} %>

