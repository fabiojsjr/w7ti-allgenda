<html>
<%@ page language="java" contentType="text/html; charset=ISO-8859-1" pageEncoding="ISO-8859-1"%>
<%@page import="java.util.ArrayList"%>
<%@page import="com.tetrasoft.app.sender.SenderInterface"%>
<%@page import="java.io.File"%>
<%@page import="java.util.List"%>
<%@page import="com.tetrasoft.data.cliente.TaskEntity"%>
<%@page import="com.tetrasoft.data.finance.SalaReuniaoEntity"%>
<%@page import="com.tetrasoft.data.usuario.LogEntity"%>

<head>
	<meta http-equiv="Accept" content="text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" ></meta>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" ></meta>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" ></meta>
	<link href="css/bootstrap.min.css" rel="stylesheet" type="text/css" />
	<link href="js/site.css" rel="stylesheet" type="text/css" />
	
	<style>
	
		@font-face {
	     font-family: RobotoRegular;
	     src: url('fonts/roboto/Roboto-Regular-webfont.html');
		}
		
		body > div.ui-dialog.ui-widget.ui-widget-content.ui-corner-all.ui-front.ui-dialog-buttons.ui-draggable > div.ui-dialog-titlebar.ui-widget-header.ui-corner-all.ui-helper-clearfix{
			background-color: #71B8EE;
		}
		
		.departamento-title2{
			line-height: 35px;
		}
		
		body,td,th {
			font-family: RobotoRegular, "Helvetica Neue", Helvetica, sans-serif;
		}
		
		html{
			overflow-y: hidden;
			position: fixed;
			width: 100vw;
		}	
		
		#header, #leftPanel, .topbar{
			display: none;		
		}
		
		.rightpanel{
			margin-left: 0px!important;
			background: #FFF;		
		}
		
		body{
			background: #FFF;
		}
		
		.linha{
			box-shadow: 1px 1px 5px #888888;
		}
		
		.containerCabecalho{
			background: rgb(222,222,225);
			height: 13vh;		
			background: #FFF;
			padding: 15px;
		}	
		
		.head-span-left{
			float: left;
	    	width: 40%!important;
		}
		
		.head-span-right{
			float: right;
	   		width: 56%!important;
		}
		
		.containerCabecalho > h3{
			font-size: 40px;
			font-weight: bold;
		}
		
		.containerCabecalho p{
			margin: 0px;
			font-size: 14px;
		}
		
		.containerCabecalho img{
			margin-top: -24px;		
		}
		
		.containerPrincipal{
			height: 55vh;		
			margin-left:0px!important;
		}
		
		.containerLeft{		
			background: rgb(6,6,6);
			width: 55%;	
			float: left;
			height: inherit;
			color: #FFF;
			box-sizing: border-box;	
			padding: 30px;	
			background: #2c3e50;
			padding-left: 15px;
			padding-right: 15px;
		}
		
		.containerLeftHeader, .containerRighttHeader {
			overflow: auto;
			font-size: 20px;
			height: 72px;
		}
		
		.img-responsive{
			display: block;
			max-width: 100%;
		}
		
		.containerLeftConteudo, .containerRightConteudo{		
			font-size: 30px;	
			margin-top:15px;		
		}
		
		.containerLeft .reuniaoDescricao2, .containerRight .reuniaoDescricao2{
			font-size: 18px;
			margin-bottom: 0px;
		}
		
		.containerLeft .reuniaoDescricao3, .containerRight .reuniaoDescricao3{
			font-size: 18px;
			margin-top: 15px;
		}
		
		
		
		.containerRight{
			background: rgb(94,94,94);
			width: 45%;	
			float: left;
			height: inherit;
			color: #FFF;
			box-sizing: border-box;	
			padding: 30px;  
			background: #425262;
			padding-left: 15px;
			padding-right: 15px;
		}
		
		.containerUltimoConteudo{
			height: 22vh;
			background: rgb(137,137,138);
			overflow: auto;
		}
		
		.reuniaoDescricao1{
			
			line-height: 45px;	
			overflow: hidden;		    
	    	max-height: 170px
		}
		
		.listReuniao{
			box-sizing:border-box;
			float: left;
			width: 20%;
			padding: 30px;
			font-size: 14px;
			color: #FFF;
			padding-left: 15px;
			padding-right: 10px;
		}
		
		.listReuniao p{
			margin: 0px;
			color: rgba(0,0,0,.7)
		}	
		.list1{
			background: rgb(137,137,139);
			height: inherit;
		}
		
		.list2{
			background: rgb(147,147,148);
			height: inherit;
		}
		
		.list3{
			background: rgb(169,169,171);
			height: inherit;
		}
		
		.list4{
			background: rgb(180,180,182);
			height: inherit;
		}
		
		.list5{
			background: rgb(190,190,192);
			height: inherit;
		}
		
		.containerMain{
			box-sizing:border-box;
			margin: 20px;	
			margin-top: 2px;
			height: calc(100vh - 30px);	
		}		
		
		.@media only screen 
		and (min-device-width : 768px) 
		and (max-device-width : 1024px) 
		and (orientation : landscape) {
		
			.containerLeftConteudo, .containerRightConteudo{		
				font-size: 30px;	
				margin-top:75px;		
			}	
		}	
		
		
		@media only screen 
		and (max-device-width : 600px)  {
		
			html{
				overflow: auto;
			    position: static;	
			    height: 120%;	    
			}
			
			.reuniaoDescricao1{
				margin: 0px!important;
			}
		
			.containerMain{
				margin: 0px!important;
				height: 100%;
			}
			
			.containerPrincipal{
				height: 400px;
			}
		
			.containerCabecalho > div:nth-child(1){		
				width: 50%;
				margin: 0px;
				display: inline-block;
			}
			
			.containerCabecalho > div:nth-child(2){		
				width: 48%;
	    		margin-right: 0px;
	    		display: inline-block;
	    		position: relative;
			}
			
			.containerCabecalho > div:nth-child(2) img{
				position: absolute;
			}
			
			.containerLeft, .containerRight{
				display: block;
				float: none;
				height: 200px;
				width: 100%;			
			}
			
			.containerLeftConteudo, .containerRightConteudo{
				font-size: 16px;
				margin-top:0px;
			
			}
			
			.containerPrincipal{
				height: 100%;			
			}
			
			.containerUltimoConteudo{
				height: 100%;
			}
			
			.listReuniao{
				width: 100%;
				display: block;
				float: none;
				padding-top: 15px;
			}
			
			.list1, .list2, .list3, .list4, .list5{
				height: 120px;
			}
			
			.tituloSala{			
				font-weight: 400;
			}
			
			.descricaoReunioes{
				margin:0px;
			}
		}
	
	</style>

</head>

<%@ include file="logadoForce.jsp" %>
<%@ include file="idioma.jsp" %>
<%@ include file="methods.jsp" %>

<body id="body">

<%	
	int idFunc = SalaReuniaoEntity.ID_FUNCAO;
	if (usuarioLogado == null || usuarioLogado.semPermissaoAcesso(idFunc) ) { %> 
		<script type="text/javascript">location.href = "painel.jsp";</script>
<%	
		return;
	}

	boolean master = false;
	if( !usuarioLogado.semPermissaoAcesso(idFunc, "excluir") ) {
		master = true;
	}
	
	try {
		
		SimpleDateFormat dataFormatTeste = new SimpleDateFormat("dd/MM/yyyy HH:mm");
		
		List<TaskEntity> reuniaoAtual = null;
		List<TaskEntity> proximasReunioes = null;
		
		new LogEntity( LogEntity.TIPO_SITE, usuarioLogado.getIdUsuario(), usuarioLogado.getTableName(), usuarioLogado.get_IDFieldName(), request.getRemoteAddr(), request.getLocalName(), 0l, "Sala de reunião: lista");
		
		SimpleDateFormat formatData2 = new SimpleDateFormat("dd/MM/yyyy");
		SimpleDateFormat formatData = new SimpleDateFormat("HH:mm");
		String idSalaReuniao = request.getParameter("id");
		String urlGoogleCalendar = request.getParameter("urlGoogleCalendar");
		List<TaskEntity> listReunioes = new ArrayList<TaskEntity>();
		SalaReuniaoEntity salaReuniao = new SalaReuniaoEntity();
		TaskEntity task = new TaskEntity();
		
		//verifica se o id da sala está na url
		if(idSalaReuniao != null && !idSalaReuniao.equals("")){
			
			//busca a sala de reuniao
			salaReuniao.getThis(" idSalaReuniao =" + idSalaReuniao);	
			
			//recupera a reunião que está ocorrendo no momento
			reuniaoAtual = task.get(" idSala=" + idSalaReuniao + " AND NOW() BETWEEN dataHoraPrazo AND dataHoraPrazoFinal ORDER BY dataHoraPrazo ASC LIMIT 1");
			
			//se estiver uma reuniao ocorrendo no momento pega as outras reunioes seguidas dessa
			if(reuniaoAtual != null && reuniaoAtual.size() > 0)
				proximasReunioes = task.get(" idSala=" + idSalaReuniao + " AND dataHoraPrazo > '" +  reuniaoAtual.get(0).getDataHoraPrazo() + "' ORDER BY dataHoraPrazo ASC LIMIT 6");
			//caso não tenha nenhuma reunião acontecendo no momento, pega as reuniões depois do horario atual
			else
				proximasReunioes = task.get(" idSala=" + idSalaReuniao + " AND dataHoraPrazo >= NOW() ORDER BY dataHoraPrazo ASC LIMIT 6");
			
			//verifica se tem reunião no momento atual
			//se tivet sta a reuniao na lista, se não tiver sena a primeira reunião como null
			if(reuniaoAtual != null && reuniaoAtual.size() > 0)
				listReunioes.add(reuniaoAtual.get(0));
			else
				listReunioes.add(null);
			
			
			//coloca todas as reuniões no array de reuniões
			if(proximasReunioes.size() > 0){
				
				for(TaskEntity ob : proximasReunioes){
					listReunioes.add(ob);
				}				
			}		
		}		
%>
<div class="containerMain">	
	<div class="row-fluid linha">		
		<div class="span12 containerCabecalho" style="margin-left:0px">
			<div class="head-span-left">
				<h3 class="tituloSala" style="margin:0px!important"><%=salaReuniao.getNome()%></h3>
				<p style="display:none" class="idSalaReuniao"><%=salaReuniao.getIdSalaReuniao()%></p>
				<p>Reuni&otilde;es marcadas.</p>						
			</div>				
			<div class="head-span-right">
				<a href="painel.jsp" class="linkPainel">
					<img src="images/logo/logo2.png" class="pull-right img-responsive" width="200px" height="100px"/>					
				</a>				
			</div>			
		</div>
		<div class="span12 containerPrincipal">
			<div class="containerLeft">
				<div class="containerLeftHeader">
					<p class="pull-left">Reuni&atilde;o atual</p>					
					<%if(listReunioes != null && listReunioes.size() > 0 && listReunioes.get(0) != null){%>
						<div class="pull-right" style="overflow:auto">
							<p><%= formatData2.format(listReunioes.get(0).getDataHoraPrazo())%></p>
							<p><%= formatData.format(listReunioes.get(0).getDataHoraPrazo())%> - <%= formatData.format(listReunioes.get(0).getDataHoraPrazoFinal())%></p>
						</div>																		
					<%}%>														
				</div>
				<div class="containerLeftConteudo">
					<%if(listReunioes != null && listReunioes.size() > 0 && listReunioes.get(0) != null){%>						
						<p class="reuniaoDescricao2"><%= listReunioes.get(0).getSolicitante() == null ? "" : "Solicitante: " + listReunioes.get(0).getSolicitante() %></p>
						<p class="reuniaoDescricao3"><%= listReunioes.get(0).getNomesParticipantes() == null ? "" : "Participantes: " %></p>	
						<p class="reuniaoDescricao2"><%= listReunioes.get(0).getNomesParticipantes() == null ? "" : task.separarNomes(listReunioes.get(0).getNomesParticipantes())%></p>
						<p class="reuniaoDescricao3"><%= listReunioes.get(0).getDescricao() == null ? "" : listReunioes.get(0).getDescricao()%></p>												
					<%}else{%>
						<p class="reuniaoDescricao1">Nenhuma reuni&atilde;o marcada.</p>
					<%}%>			
				</div>
			</div>
			<div class="containerRight" style="margin-left:0px;">
				<div class="containerRighttHeader">
					<p class="pull-left">Pr&oacute;xima Reuni&atilde;o</p>					
					<%if(listReunioes != null && listReunioes.size() > 1 && listReunioes.get(1) != null){%>
						<div class="pull-right" style="overflow:auto">
							<p><%= formatData2.format(listReunioes.get(1).getDataHoraPrazo())%></p>
							<p><%= formatData.format(listReunioes.get(1).getDataHoraPrazo())%> - <%= formatData.format(listReunioes.get(1).getDataHoraPrazoFinal())%></p>
						</div>																		
					<%}%>														
				</div>
				<div class="containerRightConteudo">
					<%if(listReunioes != null && listReunioes.size() > 1 && listReunioes.get(1) != null){%>						
						<p class="reuniaoDescricao2"><%= listReunioes.get(1).getSolicitante() == null ? "" : "Solicitante: "  + listReunioes.get(1).getSolicitante()%></p>
						<p class="reuniaoDescricao3"><%= listReunioes.get(1).getNomesParticipantes() == null ? "" : "Participantes: " %></p>		
						<%= listReunioes.get(1).getNomesParticipantes() == null ? "" : task.separarNomes(listReunioes.get(1).getNomesParticipantes())%>
						<p class="reuniaoDescricao3"><%= listReunioes.get(1).getDescricao() == null ? "" : listReunioes.get(1).getDescricao()%></p>										
					<%}else{%>	
						<p class="reuniaoDescricao1">Nenhuma reuni&atilde;o marcada.</p>
					<%}%>				
				</div>
			</div>
		</div>
		<div class="span12 containerUltimoConteudo" style="margin-left:0px; overflow: auto;">			
			<div class="listReuniao list1">
				<%if(listReunioes != null && listReunioes.size() > 2 && listReunioes.get(2) != null){%>	
					<p style="color:#000;"><%= formatData2.format(listReunioes.get(2).getDataHoraPrazo())%></p>
					<p style="color:#000;"><%= formatData.format(listReunioes.get(2).getDataHoraPrazo())%> - <%= formatData.format(listReunioes.get(2).getDataHoraPrazoFinal())%></p>	
					<p><%= listReunioes.get(2).getSolicitante() == null ? "" : "Solicitante: " + listReunioes.get(2).getSolicitante()%></p>												
				<%}else{%>
					<p class="reuniaoDescricao2">Nenhuma reuni&atilde;o marcada.</p>
				<%}%>
			</div>
			<div class="listReuniao list2">
				<%if(listReunioes != null && listReunioes.size() > 3 && listReunioes.get(3) != null){%>
					<p style="color:#000;"><%= formatData2.format(listReunioes.get(3).getDataHoraPrazo())%></p>										
					<p style="color:#000;"><%= formatData.format(listReunioes.get(3).getDataHoraPrazo())%> - <%= formatData.format(listReunioes.get(3).getDataHoraPrazoFinal())%></p>	
					<p><%= listReunioes.get(3).getSolicitante() == null ? "" : "Solicitante: " + listReunioes.get(3).getSolicitante()%></p>													
				<%}else{%>
					<p class="reuniaoDescricao2">Nenhuma reuni&atilde;o marcada.</p>
				<%}%>
			
			</div>
			<div class="listReuniao list3">
				<%if(listReunioes != null && listReunioes.size() > 4 && listReunioes.get(4) != null){%>
					<p style="color:#000;"><%= formatData2.format(listReunioes.get(4).getDataHoraPrazo())%></p>										
					<p style="color:#000;"><%= formatData.format(listReunioes.get(4).getDataHoraPrazo())%> - <%= formatData.format(listReunioes.get(4).getDataHoraPrazoFinal())%></p>
					<p><%= listReunioes.get(4).getSolicitante() == null ? "" : "Solicitante: " +  listReunioes.get(4).getSolicitante()%></p>																				
				<%}else{%>
					<p class="reuniaoDescricao2">Nenhuma reuni&atilde;o marcada.</p>
				<%}%>
			</div>
			<div class="listReuniao list4">
				<%if(listReunioes != null && listReunioes.size() > 5 && listReunioes.get(5) != null){%>
					<p style="color:#000;"><%= formatData2.format(listReunioes.get(5).getDataHoraPrazo())%></p>										
					<p style="color:#000;"><%= formatData.format(listReunioes.get(5).getDataHoraPrazo())%> - <%= formatData.format(listReunioes.get(5).getDataHoraPrazoFinal())%></p>	
					<p><%= listReunioes.get(5).getSolicitante() == null ? "" : "Solicitante: " +  listReunioes.get(5).getSolicitante()%></p>														
				<%}else{%>
					<p class="reuniaoDescricao2">Nenhuma reuni&atilde;o marcada.</p>
				<%}%>
			</div>
			<div class="listReuniao list5">
				<%if(listReunioes != null && listReunioes.size() > 6 && listReunioes.get(6) != null){%>
					<p style="color:#000;"><%= formatData2.format(listReunioes.get(6).getDataHoraPrazo())%></p>										
					<p style="color:#000;"><%= formatData.format(listReunioes.get(6).getDataHoraPrazo())%> - <%= formatData.format(listReunioes.get(6).getDataHoraPrazoFinal())%></p>	
					<p><%= listReunioes.get(6).getSolicitante() == null ? "" : "Solicitante: " + listReunioes.get(6).getSolicitante()%></p>															
				<%}else{%>
					<p class="reuniaoDescricao2">Nenhuma reuni&atilde;o marcada.</p>
				<%}%>
			</div>
		</div>				
	</div>	
</div>
<script src="js/jquery-1.9.1.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/moment.js"></script>
<!-- <script src="js/google-calendar-api.js"></script> -->
<script>

	var queryURL = window.location.href.substring(window.location.href.indexOf('urlGoogleCalendar'),window.location.href.indexOf('id')-1);
	var querySplit = queryURL.split("=");	
	var urlCalendar = querySplit[1];

	var API_KEY = '<%=salaReuniao.getGoogleApiKey()%>';
	var CLIENT_ID = '<%=salaReuniao.getGoogleClientKey()%>';
	var CALENDAR_ID = '<%=salaReuniao.getGoogleCalendarKey()%>';
	var SCOPES = 'https://www.googleapis.com/auth/calendar';
	var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];		
		
	function handleClientLoad() {
		if(urlCalendar != 'null' && urlCalendar != 'undefined')
	   	 	gapi.load('client:auth2', initClient);
	}	
	
	
	function initClient() {
	    gapi.client.init({
	      apiKey: API_KEY,
	      clientId: CLIENT_ID,
	      discoveryDocs: DISCOVERY_DOCS,
	      scope: SCOPES
	    }).then(function (response) {          
	      
	    	//verifica se esta  autorizado pela api    
	      if(!gapi.auth2.getAuthInstance().isSignedIn.Ab)
	    	  handleAuthClick();
	     
	    }, function(error) {
	      console.log(JSON.stringify(error, null, 2));
	    });
	  } 
	  
	function listGoogleCalendarEvents() {
	    gapi.client.init({
	        apiKey: API_KEY,
	        clientId: CLIENT_ID,
	        discoveryDocs: DISCOVERY_DOCS,
	        scope: SCOPES
	    }).then(function () {
	    
	    var request = gapi.client.calendar.events.list({
	        'calendarId': CALENDAR_ID                
	    });     
	
	    request.execute(function(events) {
	         
	        if (typeof(Storage) !== "undefined")        	  
	        	localStorage.setItem("listGoogleCalendar", JSON.stringify(events.items));            	
	    	else
	    	  alert("Erro ao buscar os dados do Google Calendar");        	
	    });      
	
		}, function(error) {
		  console.log(JSON.stringify(error, null, 2));
		});
	} 
  
  //chama a tela de autorização
  function handleAuthClick(event) {
    gapi.auth2.getAuthInstance().signIn();
  }
  
  //desloga as credenciais
  function handleSignoutClick(event) {
    gapi.auth2.getAuthInstance().signOut();
  } 
  

  
</script>

<script>	
	
	//grava os eventos no banco de dados
	//com.tetrasoft.web.finance.EventosServlet
	function saveEventosGoogle(){
		
		var eventos;	
		
		if(urlCalendar != 'null' && urlCalendar != 'undefined'){
			
			setTimeout(function(){
				
				//js/google-calendar-api.js
				listGoogleCalendarEvents();
				
				var myData = {};
				
				eventos = localStorage.getItem("listGoogleCalendar");
				
				if(eventos != null && eventos != 'undefined')
					eventos = JSON.parse(eventos);
				
				localStorage.removeItem("listGoogleCalendar");
				
				$(eventos).each(function(i,e){
					
					myData.dataInicial = formatDataGoogleCalendar(e.start.dateTime);
					myData.dataFinal = formatDataGoogleCalendar(e.end.dateTime);			
					myData.idGoogle = e.id;
					myData.sala = <%=idSalaReuniao%>;
					myData.descricao = e.summary;
					myData.solicitante = e.creator.email;		
					
					$.ajax({
						url: 'eventosServlet',
						type: 'POST',
						data: myData,
						success: function(response){
							console.log(response);
						},error: function(error,xhr,throwable){
							console.log(error);
						}
					});			
				});
				
			},2000);			
		}					
	}
	
	//formata a data retornada da API google calendar
	function formatDataGoogleCalendar(data){
		
		var dataInicialSplit = data.split('T');
		var horaInicialSplit = dataInicialSplit[1].split("-"); 
		var data = dataInicialSplit[0];
		var hora = horaInicialSplit[0]; 
		
		return data + 'T' + hora;		
	}
	
	$(document).ready(function(){		
		
		saveEventosGoogle();		
	});
	
	//recarrega a página a cada 30 segundos
	setTimeout( function() {window.location = window.location.href;},30000);
	
</script>
<script async defer src="https://apis.google.com/js/api.js"
 onload="this.onload=function(){};handleClientLoad()"
 onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>
<%
} catch( Exception e ) {
	e.printStackTrace();
} 
%>
</body>
</html>