package com.tetrasoft.util;

import java.util.Date;
import java.util.Properties;

import javax.mail.Multipart;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeBodyPart;
import javax.mail.internet.MimeMessage;
import javax.mail.internet.MimeMultipart;
import javax.mail.internet.MimeUtility;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.util.EntityUtils;

import com.technique.engine.util.ExceptionWarning;
import com.technique.engine.web.CommandWrapper;
import com.technique.engine.web.RendererXSLtoHTML;
import com.tetrasoft.data.cliente.ConfigEntity;

public class SendMailSparkpost {
	public static String MAILER = "TechEngine";
    public static String ADRESS_EXCEPTION = "AddressException";
    public static String MESSAGING_EXCEPTION = "MessagingException";

    public static boolean changeSender = true;

    public SendMailSparkpost() {
    }
    public SendMailSparkpost( boolean change ) {
        changeSender = change;
    }

    public static StringBuffer enxugarEmail(StringBuffer msg) {
    	return new StringBuffer( msg.toString().replaceAll("(?sim)<script.*?</script>",""));
    }

    public static void send(String subject, String from, String to, String contentType, StringBuffer conteudo) throws ExceptionWarning {
		try {
//			to = "renato.filipov@gmail.com";
			
//			if( true ) {
//				System.out.println("TESTE: " + to);
//				return;
//			}
			
			if( !from.contains("allgenda") ) {
				from = ConfigEntity.CONFIG.get("email");
			}
			
			if( !to.contains("@") ) {
				return;
			}
			
			conteudo = enxugarEmail(conteudo);

			String mailer 	= MAILER;
			String server 	= "smtp.sparkpostmail.com";
			String usr 		= "SMTP_Injection";
			String passwd 	= "e3b5bd50df67275c53e9fca45f73c37e0c08f9f9";
			
			Properties props = new Properties();
			props.put("mail.smtp.host", server);
			props.put("mail.smtp.auth", "true");
			props.put("mail.smtp.user", usr);
			props.put("mail.smtp.pass", passwd);
			props.put("mail.smtp.port", "587");
			props.put("mail.smtp.localhost", server);
			props.put("mail.smtp.starttls.enable", "true");
			
			Session session = null;
			if(usr != null) {
//				if(passwd == null) passwd = "";

				props.put("mail.smtp.auth", "true");
				session = Session.getInstance(props, new SMTPAuthenticator(usr, passwd));
//			} else {
//				session = Session.getInstance(props, null);
			}

			MimeMessage mimeMessage = new MimeMessage(session);
			
			InternetAddress[] reply;

			if( from.contains("<") ) {
				String fromMail = from.substring(from.indexOf("<")+1, from.indexOf(">") );
				String fromNome = from.substring(0, from.indexOf("<") );
				
				reply = new InternetAddress[]{ new InternetAddress(fromMail) };
				from = "\"" + fromNome + "\" <" + fromMail + ">";
				
			} else {
				reply = new InternetAddress[]{ new InternetAddress(from) };
				String nome = from;
				try {
					nome = from.substring( 0, from.indexOf("@") );
				} catch (Exception e) {
				}
				
//				String c = conteudo.toString();
				nome = "Allgenda";
				
				from = "\"" + nome + "\" <" + ConfigEntity.CONFIG.get("email") + ">";
			}

			mimeMessage.setFrom(new InternetAddress(from));
			mimeMessage.setReplyTo(reply);

			javax.mail.Address toAddress = new InternetAddress(to);
			mimeMessage.addRecipient(javax.mail.Message.RecipientType.TO, toAddress);

			mimeMessage.setSubject( MimeUtility.encodeText(subject, "ISO-8859-1", "Q") );
//			mimeMessage.setDataHandler(new DataHandler(new ByteArrayDataSource(message.toString(), contentType)));
			mimeMessage.setHeader("X-Mailer", mailer);
			mimeMessage.setSentDate(new Date());

			MimeBodyPart m1 = new MimeBodyPart();
			MimeBodyPart m2 = new MimeBodyPart();
			m1.setContent( conteudo.toString(), contentType );
			m2.setContent( convertPlain(conteudo.toString()), "text/plain" );

			Multipart mp = new MimeMultipart();
			mp.addBodyPart( m2 );
			mp.addBodyPart( m1 );

			MimeMultipart mm = new MimeMultipart("alternative");
			mm.addBodyPart( m2 );
			mm.addBodyPart( m1 );

			mimeMessage.setContent( mm );

			System.out.println("STAL SendMail SparkPost: " + to);
			
			try {
				Transport.send(mimeMessage);
			} catch (Exception e) {
				System.out.println("SendMail ERROR - " + to);
				e.printStackTrace();
			}
			mimeMessage = null;
			
		} catch(Exception e) {
			e.printStackTrace();
			throw new ExceptionWarning("SendMail.send fail - " + ADRESS_EXCEPTION, e);
		}
	}
    
    protected static String convertPlain( String s ) {
        try {
          s = s.replaceAll("(?sim)<br><br>", "<br>");

          s = s.replaceAll("\r","");
          s = s.replaceAll("\n","");

          try {
              s = s.substring( s.indexOf("<font face=\"Verdana\" size=\"1\" color=\"#ffffff\">"), s.length() );
          } catch (Exception e2) {
          }

          s = s.replaceAll("(?sim)<script.*?</script>","");
          s = s.replaceAll("(?sim)<(/|)form.*?>","");
          s = s.replaceAll("(?sim)<(/|)input.*?>","");
          s = s.replaceAll("(?sim)<(/|)img.*?>","");
          s = s.replaceAll("(?sim)&nbsp;","");
          s = s.replaceAll("Topo","");

          s = s.replaceAll("(?sim)<br>","\n\r");
          s = s.replaceAll("(?sim)<tr.*?>","\n\r");
          s = s.replaceAll("(?sim)<td.*?>"," ");
          s = s.replaceAll("(?sim)<p.*?>","");
          s = s.replaceAll("(?sim)<.*?>","");

        } catch (Exception e) {
            e.printStackTrace();
            s = "";
        }

        return s;
    }
    
    protected static String getPageHTML(CommandWrapper wrapper) throws ExceptionWarning {
		try {
			return RendererXSLtoHTML.getInstance().transform(wrapper.getSID(), wrapper.getXMLData().getClone(), wrapper.getNextPage());
		} catch (Exception e) {
			throw new ExceptionWarning(e);
		}
	}
    
    public static String getEmailTopoClean() {
		String conteudo = "";
				conteudo += "<html xmlns='http://www.w3.org/1999/xhtml' xmlns:v='urn:schemas-microsoft-com:vml'>";
				conteudo += "	<head>";
				conteudo += "		<meta http-equiv='Content-Type' content='text/html; charset=ISO-8859-1' />";
				conteudo += "		<meta http-equiv='X-UA-Compatible' content='IE=edge' />";
				conteudo += "		<link href='http://" + ConfigEntity.CONFIG.get("url") + "/allgenda/js/site.css' rel='stylesheet' type='text/css'/>";
				conteudo += "	</head>";
				conteudo += "	<body>";
				conteudo += "		<table cellspacing='0' cellpadding='0' width='100%' border='0'>";
				conteudo += "			<tr>";
				conteudo += "				<td height='10' colspan='3'></td>";
				conteudo += "			</tr>";
		
		return conteudo;
    }
	public static String getEmailTopo( String idioma ) {
		if( idioma == null || idioma.equals("") ) idioma = "PT";
		
		String conteudo = "";
				conteudo += "<html xmlns='http://www.w3.org/1999/xhtml' xmlns:v='urn:schemas-microsoft-com:vml'>";
				conteudo += "	<head>";
				conteudo += "		<meta http-equiv='Content-Type' content='text/html; charset=ISO-8859-1' />";
				conteudo += "		<meta http-equiv='X-UA-Compatible' content='IE=edge' />";
				conteudo += "		<link href='http://" + ConfigEntity.CONFIG.get("url") + "/allgenda/js/site.css' rel='stylesheet' type='text/css'/>";
				conteudo += "	</head>";
				conteudo += "	<body bgcolor='#EFEFEF' style='background-color: #EFEFEF'>";
				conteudo += "		<center>";
				conteudo += "		<table style=\"width: 100.0%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"	width=\"100%\">";
				conteudo += "		<tbody>";
				conteudo += "			<tr>";
				conteudo += "				<td style=\"background: #EFEFEF; padding: 0in 0in 0in 0in\" bgcolor=\"#EFEFEF\">";
				conteudo += "					<div align=\"center\">";
				conteudo += "						<table style=\"width: 555.0pt\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"740\">";
				conteudo += "							<tbody>";
				conteudo += "								<tr>";
				conteudo += "									<td>";
				conteudo += "										<a href='http://" + ConfigEntity.CONFIG.get("url") + "'><img src='http://allgenda.org.br/allgenda/images/email/header" + idioma + ".jpg?id=2' border='0' width='100%'/></a>";
//				conteudo += "										<a href='http://" + ConfigEntity.CONFIG.get("url") + "'><img src='http://localhost:8080/allgenda/images/email/header" + idioma + ".jpg?id=1' border='0' width='100%'/></a>";
				conteudo += "									</td>";
				conteudo += "								</tr>";
				conteudo += "							</tbody>";
				conteudo += "						</table>";
				conteudo += "					</div>";
				conteudo += "				</td>";
				conteudo += "			</tr>";
				
				conteudo += "			<!-- MIOLO -->";
				conteudo += "			<tr>";
				conteudo += "				<td style=\"background: white; padding: 0in 0in 0in 0in\" bgcolor=\"white\">";
//				conteudo += "					<div align=\"center\">";
//				conteudo += "						<table style=\"width: 480.0pt\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"740\">";
//				conteudo += "							<tbody>";
//				conteudo += "								<tr>";
//				conteudo += "									<td style=\"padding: 22.5pt 15.0pt 22.5pt 15.0pt\">";
//				conteudo += "										<table style=\"width: 100.0%\" border=\"0\" cellpadding=\"0\"	cellspacing=\"0\" width=\"100%\">";
//				conteudo += "											<tbody>";
//				conteudo += "												<tr>";
//				conteudo += "													<td style=\"padding: 0in 0in 0in 0in\">";
//				conteudo += "														<table style=\"width: 100.0%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">";
//				conteudo += "															<tbody>";
//				conteudo += "																<tr>";
//				conteudo += "																	<td style=\"padding: 0in 0in 0in 15.0pt\" valign=\"top\">";
				
		return conteudo;
	}

	
	public static String getEmailRodape( String idioma ) {
		if( idioma == null || idioma.equals("") ) idioma = "PT";

		String conteudo = "</td></tr>";
//		String conteudo = "</td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></div></td></tr>";
		conteudo += "			<tr>";
		conteudo += "					<td style=\"background: #EFEFEF; padding: 0in 0in 0in 0in\" bgcolor=\"#EFEFEF\">";
		conteudo += "						<div align=\"center\">";
		conteudo += "							<table cellpadding=\"0\" cellspacing=\"0\" width=\"740\">";
		conteudo += "								<tbody>";
		conteudo += "									<tr>";
		conteudo += "										<td>";
		conteudo += "											<a href='http://" + ConfigEntity.CONFIG.get("url") + "'><img src='http://allgenda.org.br/allgenda/images/email/footer" + idioma + ".jpg?id=2' border='0' width='100%'/></a>";
//		conteudo += "											<a href='http://" + ConfigEntity.CONFIG.get("url") + "'><img src='http://localhost:8080/allgenda/images/email/footer" + idioma + ".jpg?id=1' border='0' width='100%'/></a>";
		conteudo += "										</td>";
		conteudo += "									</tr>";
		conteudo += "								</tbody>";
		conteudo += "							</table>";
		conteudo += "						</div>";
		conteudo += "					</td>";
		conteudo += "				</tr>";
		conteudo += "			</tbody>";
		conteudo += "		</table>";
		conteudo += "	</body>";
		conteudo += "</html>";
		
		return conteudo;
	}
	public static String getEmailRodapeClean() {
		String conteudo = "";
				conteudo += "			<tr>";
				conteudo += "				<td height='10' colspan='3'><hr></td>";
				conteudo += "			</tr>";
				conteudo += "		</table>";
				conteudo += "	</center>";
				conteudo += "	</body>";
				conteudo += "</html>";
		
		return conteudo;
	}
	
	public static void enviarEmailPadrao( String email, String mensagem, String idioma ){
		try {
			String conteudo = SendMailSparkpost.getEmailTopo(idioma);
			
			conteudo += "<tr>";
			conteudo += "	<td colspan='3' align='center'>" + mensagem + "</td>";
			conteudo += "</tr>";
			
			conteudo += SendMailSparkpost.getEmailRodape(idioma);
			
			SendMailSparkpost.send("Mensagem", ConfigEntity.CONFIG.get("email"), email, "text/html", new StringBuffer(conteudo) );
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
    
	public static String lerHTML(String url) {
		try {
			System.out.println(url);
	        DefaultHttpClient httpclient = new DefaultHttpClient();

			HttpGet httpget1 = new HttpGet(url);
//			httpget1.setHeader("Host","nnex.com");
//			httpget1.setHeader("User-Agent","Mozilla/5.0 (Windows; U; Windows NT 6.0; pt-BR; rv:1.9.0.12) Gecko/2009070611 Firefox/3.0.12 (.NET CLR 3.5.30729)");
//			httpget1.setHeader("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8");		
//			httpget1.setHeader("Accept-Language","pt-br,pt;q=0.8,en-us;q=0.5,en;q=0.3");
//			httpget1.setHeader("Accept-Encoding","gzip, deflate");
//			httpget1.setHeader("Accept-Charset","ISO-8859-1,utf-8;q=0.7,*;q=0.7");
//			httpget1.setHeader("Connection","Keep-Alive");
//			httpget1.setHeader("Keep-Alive","300");
			
			HttpResponse response = httpclient.execute(httpget1);
			HttpEntity entity = response.getEntity();
			
//			if (entity != null) {
//				entity.consumeContent();
//			}
			
			return EntityUtils.toString(entity); 
		} catch (Exception e) {
			e.printStackTrace();
		}

		return "";
	}
	
    public static void main(String[] args) {
		try {
			String conteudo = SendMailSparkpost.getEmailTopo("PT");
			
			conteudo += "<tr>";
			conteudo += "	<td colspan='3' align='left'>" +
					"			<b>Olé TESTE, </b>" +
					"			<br/><br/>" +
					"			Seja muito bem vindo é  " + ConfigEntity.CONFIG.get("nome") + "." +
					"			<br/><br/>" +
					"			Essa é uma mensagem para demonstrar como vai ficar o novo topo e rodapé." +
					"			<br/><br/>" +
					"			Estamos inteiramente é sua disposiééo." +
					"			<br/><br/>" +
					"			Atenciosamente," +
					"			<br/><br/><br/>" +
					"			Equipe  " + ConfigEntity.CONFIG.get("nome") +		
					"		</td>";
			conteudo += "</tr>";
			
			conteudo += SendMailSparkpost.getEmailRodape("PT");		
			
			SendMailSparkpost.send("TESTE", ConfigEntity.CONFIG.get("email"), "renato.filipov@gmail.com", "text/html", new StringBuffer(conteudo) );
		} catch (ExceptionWarning e) {
			e.printStackTrace();
		}
	}
}