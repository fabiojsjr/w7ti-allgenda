<%@page import="com.tetrasoft.data.cliente.Calendario"%>
<%@page import="com.tetrasoft.data.cliente.TaskEntity"%>
<%@page import="java.util.Date"%>
<%@ page language="java" contentType="text/html; charset=ISO-8859-1" pageEncoding="ISO-8859-1"%>
<%@page import="java.text.SimpleDateFormat"%>
<%@page import="java.util.ArrayList"%>
<%@page import="java.sql.Connection"%>

<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="js/fullcalendar.min.js"></script>

<a id="dynCalendar" class="grouped_elements"></a>

<script type="text/javascript" id="runscript">
	<!-- CALENDÁRIO -->
	var start = 0;
	var date = new Date();
	var d = date.getDate();
	var m = date.getMonth();
	var y = date.getFullYear();

	var eventoSelecionado;
	var acesso = false;

	jQuery(document).ready(function() {
		setupCalendar();
	});

	
	function setupCalendar() {
		var calendar = jQuery('#calendar').fullCalendar({
			header: {
				left: 'prev,next today',
				center: 'title',
				right: 'month,agendaWeek,agendaDay'
			},
			
			<% if( idioma.equals("PT") ) { %>
					monthNames: ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'],
					monthNamesShort: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'], dayNames: ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'], 
					dayNamesShort: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'], buttonText: {   prev: '&nbsp;&#9668;&nbsp;',    next: '&nbsp;&#9658;&nbsp;',  
					prevYear: '&nbsp;&lt;&lt;&nbsp;',   nextYear: '&nbsp;&gt;&gt;&nbsp;',   today: 'hoje',  month: 'mês',   week: 'semana', day: 'dia'  }, 
					titleFormat: {  month: 'MMMM yyyy', week: "d [ yyyy]{ '&#8212;'[ MMM] d MMM yyyy}", day: 'dddd, d MMM, yyyy'    }, 
					columnFormat: { month: 'ddd',   week: 'ddd d/M',    day: 'dddd d/M' },  
					allDayText: 'dia todo', axisFormat: 'H:mm', timeFormat: {   '': 'H(:mm)',   agenda: 'H:mm{ - H:mm}' },
					buttonText: {
						prev: '&laquo;',
						next: '&raquo;',
						prevYear: '&nbsp;&lt;&lt;&nbsp;',
						nextYear: '&nbsp;&gt;&gt;&nbsp;',
						today: 'hoje',
						month: 'mês',
						week: 'semana',
						day: 'dia',
					},
			<%	} %>
			
			eventClick: function(event, element) {
				eventoSelecionado = event;
				acesso = true;
        		$('#calendar').fullCalendar('updateEvent', event);
    		},
    		
			eventDrop: function(event, element) {
				ChamaPaginaArray("calendarioPainel.jsp?change=true&id=" + event.name + "&data=" + event.start + "&idCalendario=<%= idCalendario %>", "centroPainel", "activateCalendar(1)");
    		},
    		
			eventAfterAllRender : function(view){
				$('a.grouped_elements').fancybox(
					{
						titleShow: false,
						transitionIn : 'elastic',
						transitionOut : 'elastic',
						autoDimensions: true,
						overlayShow : true,
						autoScale: true,
						easingIn : 'easeOutBack',
						easingOut : 'easeInBack',
						width: 910,
						scrolling: 'no',
					});
			},

			selectable: true,
			selectHelper: true,
			select: function(start, end, allDay) {
				
		    document.getElementById('dynCalendar').href= "calendarioEdit.jsp?start=" + start + "&idCalendario=<%= idCalendario %>";
		    document.getElementById('dynCalendar').click();
				

				/*
				var title = prompt('Event Title:');
				if (title) {
					calendar.fullCalendar('renderEvent',
						{
							title: title,
							start: start,
							end: end,
							allDay: allDay
						},
						true // make the event "stick"
					);
					ChamaPaginaArray("calendarioPainel.jsp?save=true&titulo=" + title + "&data=" + start, "centroPainel", "activateCalendar(1)");
				}
				*/
				
				calendar.fullCalendar('unselect');
				
			},
			editable: true,
			
			events: [
				<%
					Calendario cal = new Calendario();
					ArrayList<String> list2 = cal.getTODO( usuarioLogado.getIdUsuario(), idCalendario, false );

					for( String s : list2 ) {
						StringTokenizer st = new StringTokenizer( s, "|");
						
						String data       = st.nextToken();
						String id         = st.nextToken();
						String tipoAlerta = st.nextToken();
						if( tipoAlerta.equals("2") ) continue;
						String tipo       = st.nextToken();
						String evento     = st.nextToken();
//						String cliente    = st.nextToken();
						String resp       = st.nextToken();
						String color      = "#4C4C4C";
						
						
						if( !usuarioLogado.getIdUsuario().toString().equals( resp ) ) {
							if( TaskEntity.DATE_FORMAT7.parse( data ).before( new Date() ) ) {
								color = "#FF5555";
							} else {
								color = "darkorange";
							}
						} else {
							if( TaskEntity.DATE_FORMAT7.parse( data ).before( new Date() ) ) {
								color = "red";
							}
						}
						
				%>
						{
							name : '<%= id %>|<%= tipo %>',
							title : '<%= evento %>',
							start : new Date('<%= data %>'),
							allDay : false,
							color : '<%= color %>',
							url : 'calendarioEdit.jsp?id=<%= id %>&tipo=<%= tipo %>&idCalendario=<%= idCalendario %>'
						},
						
				<%	}	%>
			         
			         
				/*
					{
						title : 'Demi Lovato',
						start : new Date('2016-02-15 17:10:00.0'),
						url : 'adminPacienteConsultaEdit.jsp?idPaciente=1421441677638&idConsulta=1421443981678'
					},	
				
					{
						title : 'Robert de Niro',
						start : new Date('2016-02-12 17:10:00.0'),
						url : 'adminPacienteConsultaEdit.jsp?idPaciente=1421441677638&idConsulta=1421443981678'
					},	
				*/
				
			]
		});
		
	}	
</script>

<%	if( request.getParameter("ajax") == null ) { %>
		<div id='calendar'></div>
		
<%	} else { %>
		<ul class="breadcrumbs">
			<li><a style="color : black;" href="painel.jsp"><i class="iconfa-user"></i></a> <span class="separator"></span></li>
			<li><%= p.get("ADMINISTRACAO") %><span class="separator"></span></li>
			<li><b>Calendário</b></li>
		</ul>
		
		<div class="pageheader" onclick="javascript:calendario(1,0);" style="cursor: pointer;">
			<div class="pageicon"><span class="iconfa-calendar"></span></div>
			<div class="pagetitle">
				<h5> &nbsp;</h5>
				<h1>Calendário</h1>
			</div>
		</div>

		<center>
			<div id="dashboard-left" class="span8" style="width: 95%; margin-top: 20px">
				<!div class="alert alert-error">
		
				<div class="widgetcontent font1" style="text-align: justify; border-top: 2px solid #2C3E50">
					<div id='calendar'></div>
				</div>
			</div><!--span6-->
		</center>
		  	
<%	} %>

