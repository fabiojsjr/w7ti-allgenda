package com.tetrasoft.web.finance;

import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.List;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.google.gson.Gson;
import com.technique.engine.util.ExceptionInjection;
import com.technique.engine.util.ExceptionWarning;
import com.tetrasoft.data.cliente.TaskEntity;
import com.tetrasoft.data.finance.EventoEntity;

@WebServlet("/eventosServlet")
public class EventosServlet extends HttpServlet {
	
	private static final long serialVersionUID = 1L;
	
	@Override
	protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		
			req.setCharacterEncoding("UTF8");
			resp.setCharacterEncoding("UTF-8");			
			String id = req.getParameter("id");		
			List<EventoEntity> listEventos = new ArrayList<EventoEntity>();
			SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
			
			TaskEntity entity = new TaskEntity();
			List<TaskEntity> listTask = null;
			String json = "";
			
			try {
				
				if(id != null && !id.equals("")) {
					listTask = entity.get(" idSala=" + id);
				}else {
					listTask = entity.get(" 1=1");					
				}								
				
				if(listTask.size() > 0) {					
					
					for(TaskEntity ob : listTask) {
						EventoEntity evento = new EventoEntity();
						evento.setName(ob.getIdTask().toString() + "|" + ob.getTipo().toString());
						evento.setTitle(ob.getDescricao());
						evento.setStart(dateFormat.format(ob.getDataHoraPrazo()));
						evento.setEnd(dateFormat.format(ob.getDataHoraPrazoFinal()));
						evento.setAllDay(false);
						evento.setColor("red");
						evento.setUrl("calendarioEdit.jsp?id=" + ob.getIdTask() + "&tipo=" + ob.getTipo() + "&idCalendario=0");
						listEventos.add(evento);					
					}
					
					Gson gson = new Gson();
					
					json = gson.toJson(listEventos);					
					
					resp.getWriter().write(json);
				}				
				
			} catch (ExceptionWarning e) {
				
				e.printStackTrace();
				
			} catch (ExceptionInjection e) {
				
				e.printStackTrace();
			}		

	}
	
}
